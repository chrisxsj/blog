
# migration

**作者**

Chrisx

**日期**

2021-06-15

**内容**

数据库迁移、方法论、实践

----

[toc]

## 1. 概述

数据迁移，是一个非常复杂的过程，不仅仅是将数据从一个地方移动到另一个地方。这里需要考虑架构变更、应用改造、数据移动、数据安全等诸多方面问题。在实际迁移工作中，需要结合企业的方方面面，做好合理的规划及实施，否则很可能会导致迁移结果达不到预期，浪费人力财力，甚至影响业务运行。在正式开始迁移之前，有几项工作是需要提前考虑的。

### 1.1 迁移目的

在我们正式开展迁移之前，首先要对迁移目的有个清晰的定位。后面的很多工作的前提，正基于此。下面罗列下常见的目的，真实场景中可能包含一个或多个的组合。

* 成本
    现有方案成本过高，因而考虑至低成本方案。（需要考虑经济、时间、人力、风险、回退成本等多种因素）
* 性能
    现有方案不能满足性能要求。
* 空间
    现有方案不能满足容量要求（需要考虑现有存量使用及未来增量情况）
* 软硬件更换升级
    新版本，新功能，新架构。
* 自主可控
    政策性要求，国产化需求。
* 其他
    业务需求变化需要，业务发展变化，也对于支撑平台的需求不断变化。
    企业自身的技术发展需要。

### 1.2 业务场景分析

在着手迁移之前，需要对现有业务做了全面的梳理，重点是将其对数据载体的要求整理清楚。

| 应用场景 | 数据指标       | 性能指标                 | 其他         |
| -------- | -------------- | ------------------------ | ------------ |
| oltp     | 结构化，500GB+ | 响应时间5s内，并发1000+  | 吞吐量 10GB+ |
| olap     | 半结构化，5TB+ | 响应时间5min内，并发100+ | 存在xml数据  |

### 1.3 迁移需求分析

在对业务场景做好必要的分析工作后，我们还需要针对迁移需求做更多细致的工作。主要包括

* 硬件环境
    业务系统使用的资源情况（CPU、MEM、STORAGE等）这些信息
* 网络环境
    业务系统的网络配置和网络隔离情况，需要开放的端口号等
* 操作系统
    业务系统使用的操作系统，是Linux还是Windows，是32位还是64位，其使用的文件系统是什么？
* 数据库和数据
    数据库类型，是hgdb还是pg，使用的那个版本？数据规模多大。
* 应用系统
    应用系统是采用商用的还是自研的，使用什么开发语言、版本是什么，接入驱动类型（JDBC、ODBC等）？
* 时间需求
    迁移总体需要多长时间？
* 客户其他要求。

:warning: 针对以上需求分析，做成表格

### 1.4 迁移难点

* 数据安全
    迁移操作过程中，保证数据的安全性至关重要。除了考虑在迁移前必要的数据备份外，还要考虑清楚迁移过程中数据增量问题，以及出现异常问题后的安全回退等。
* 兼容性
    兼容性是整个数据迁移方案得以实施的前提。需要考虑原有平台与现有平台的兼容性，特别是数据库的兼容性。
* 停机时间
    停机时间要考虑整个迁移过程，包括迁移正常完成迁移的时间，切换的时间，回退的时间。更具迁移方式不同，时间也不同。在线迁移要比离线迁移时间短，但风险性也高
* 数据校验
    在整个的数据迁移过程中，采用的迁移方式多种多样。由于误操作或者迁移方案缺陷极有可能导致数据库数据的不一致。在迁移的过程中，应该制定严格的数据验证过程。在迁移前后，要有充分的准备。避免由于误操作导致数据库的数据库准确性问题。建议客户采用并行混跑方式，有较长的时间窗口可以充分验证新环境的数据准确性，避免出现发现异常而无法回退的情况。
* 性能保证
    迁移后需要进行性能优化，避免影响业务运行。一般建议在正式迁移之前，进行预迁移在全量数据环境下的模拟压力测试，验证性能表现。

:warning: 针对以上迁移难点，做成表格

## 2. 迁移过程

### 2.1 迁移前

#### 制定迁移方案

在迁移之前，最为重要的就是确定迁移方案。明确迁移方式，确定具体迁移步骤（含迁移、回退、验证等）。

主流数据库迁移方式有三种

1. 同种数据库，可以采用备份、还原方式
2. 异构的话，可以采用导入、导出方式。
3. 基于日志的迁移方式。可实现同构、异构、跨平台的迁移，同时支持增量数据迁移。如逻辑复制、hvr、ogg

迁移时 先考虑全量迁移，这种方式是异步的，集中处理，这样效率比较高，但停机时间比较长。如果客户对于迁移时间有要求，同时要求过程安全可控，可考虑给予日志迁移方式。考虑到回退流程，最好实现双向同步，这样复杂度也会提高。

基于日志流程如下（hvr）

1. 配置双写环境，部署新数据库，即同时存在新旧两个数据库，都可对外提供读写服务。
2. 正向数据同步，基础数据搬迁，将基础数据从旧数据库搬迁到新数据库。增量数据搬迁，通过新旧两个数据库数据实时同步保证。需要工具支持。如记录历史数据库快照点，并从快照点进行数据增量同步。
注意：数据搬迁过程中，观察旧库资源使用情况，避免资源用尽宕机情况。
3. 反向数据同步，配置反向数据同步。以便安全可控的进行回退。工具支持的话，可以配置双向同步。
4. 数据测试及校验，
5. 业务切换，业务系统切换至新数据库进行读写。
注意：业务切换时，先停止业务》然后关闭正向同步》启用反向同步》切换业务
6. 旧系统清理，根据情况，立即或运行一段时间后，清理回收旧系统资源，全部流程结束。

#### 方案测试

在明确了迁移方案后，需进行完备的方案测试，验证方案可行性，并完善方案。

### 2.2 迁移中

在整体迁移过程中，一般遵循从规划阶段->准备阶段->迁移阶段->验证阶段->投产阶段的顺序。当在验证阶段出现问题时，可能需要回溯到规划阶段进行调整甚至放弃此方案；但投产阶段出现问题是，需要退回到验证阶段重新评测优化。（下面的迁移方案中，按照最为常见的数据库迁移方案进行说明）

#### 迁移阶段

* 权限迁移
    这里包括用户、角色、权限迁移。
* 对象迁移
    表对象，元数据和数据部分。数据迁移包括全量和增量数据迁移。
    其他数据对象，序列、视图、存储过程、函数、触发器，索引等

#### 验证阶段

业务测试、性能测试、问题修复、性能优化、培训辅导

#### 投产阶段

系统割接、运维保障、后期维护

### 2.3 迁移后

生成迁移前后对比报告。
对仍然存在的遗留问题，需要重点关注。
